name: Deploy to Firebase Hosting on Merge

# 実行トリガーの定義: main ブランチへのプッシュ時 (merge 相当)
on:
  push:
    branches:
      - main

# 環境変数の定義 (ビルド環境を明示)
env:
  NODE_VERSION: '20' # 使用するNode.jsのバージョン
  BUILD_DIR: 'build' # Reactのビルド成果物ディレクトリ (firebase.jsonと一致)

# 実行するジョブの定義
jobs:
  build_and_deploy:
    name: Build & Deploy to Live Channel
    
    # 実行環境の指定
    runs-on: ubuntu-latest
    
    # ジョブの実行手順
    steps:
      # 1. リポジトリのコードをチェックアウト
      - name: Checkout repository code
        uses: actions/checkout@v4 

      # 2. Node.js環境のセットアップ (★追加★: ビルドに必要なNode.jsを設定)
      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm' # npmキャッシュを有効化 (高速化)

      # 3. 依存関係のインストール (★追加★: package.jsonに基づいてライブラリをインストール)
      - name: Install dependencies
        run: npm ci

      # 4. Reactアプリケーションのビルド (★追加★: 公開用の'build'ディレクトリを生成)
      - name: Build React App
        run: npm run build
        
      # 5. Firebase Hostingへのデプロイ
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          # Firebase CLIが自動生成したSecrets名を使用
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_STUDY_TIME_2664A }} 
          channelId: live
          projectId: study-time-2664a